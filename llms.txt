# neuron

> Composable building blocks for AI agents in Rust. Independent crates, not a framework — pull one block without buying the whole stack.

neuron is a workspace of independent Rust crates that provide the foundation layer for building AI agent applications. Each crate is versioned and published separately. Blocks compose through traits defined in neuron-types; no block knows about any other block — only the traits it depends on.

## Why neuron?

We studied every Rust and Python agent framework. They all converge on the same ~300-line while loop. The differentiation is never the loop — it's the blocks around it: context management, tool pipelines, durability, runtime. Nobody ships those blocks independently. neuron fills that gap.

neuron is **serde, not serde_json**. It defines traits, provides foundational implementations, and gets out of the way. Frameworks compose these blocks into opinionated workflows.

## Architecture

Dependencies flow upward. Each block depends only on neuron-types and the blocks directly below it.

```
neuron-types                    (zero deps, the foundation)
    ^
    |-- neuron-provider-*       (each implements Provider trait)
    |-- neuron-tool             (implements Tool trait, registry, middleware)
    |-- neuron-mcp              (wraps rmcp, bridges to Tool trait)
    +-- neuron-context          (+ optional Provider for summarization)
            ^
        neuron-loop             (composes provider + tool + context)
            ^
        neuron-runtime          (sessions, DurableContext, guardrails, sandbox)
            ^
        neuron                  (umbrella re-export, build LAST)
```

## Key Traits (all in neuron-types)

- [Provider](https://docs.rs/neuron-types/latest/neuron_types/trait.Provider.html): `complete(CompletionRequest) -> CompletionResponse` and `complete_stream(CompletionRequest) -> StreamHandle`. RPITIT, not object-safe; use generics.
- [EmbeddingProvider](https://docs.rs/neuron-types/latest/neuron_types/trait.EmbeddingProvider.html): `embed(EmbeddingRequest) -> EmbeddingResponse`. Separate from Provider — not all models support both.
- [Tool](https://docs.rs/neuron-types/latest/neuron_types/trait.Tool.html): `definition() -> ToolDefinition`, `call(Args, ToolContext) -> Result<Output, Error>`. Strongly typed.
- [ToolDyn](https://docs.rs/neuron-types/latest/neuron_types/trait.ToolDyn.html): Type-erased version for `ToolRegistry` storage. Derive with `#[neuron_tool]`.
- [ContextStrategy](https://docs.rs/neuron-types/latest/neuron_types/trait.ContextStrategy.html): `should_compact(messages, token_limit) -> bool`, `compact(messages) -> messages`, `token_estimate(messages) -> usize`
- [ObservabilityHook](https://docs.rs/neuron-types/latest/neuron_types/trait.ObservabilityHook.html): `on_event(HookEvent) -> HookAction` (Continue, Skip, Terminate)
- [DurableContext](https://docs.rs/neuron-types/latest/neuron_types/trait.DurableContext.html): `execute_provider(request) -> response`, `execute_tool(name, input) -> output`. Wraps side effects for Temporal/Restate.
- [PermissionPolicy](https://docs.rs/neuron-types/latest/neuron_types/trait.PermissionPolicy.html): Tool call authorization at runtime.

## Crates

- [neuron-types](https://docs.rs/neuron-types): Shared types and traits — Message, ContentBlock, Provider, Tool, ContextStrategy, error types
- [neuron-tool](https://docs.rs/neuron-tool): Tool registry with middleware pipeline (validate, permissions, hooks, format)
- [neuron-tool-macros](https://docs.rs/neuron-tool-macros): `#[neuron_tool]` proc-macro for deriving Tool implementations
- [neuron-context](https://docs.rs/neuron-context): Context engine — SlidingWindowStrategy, ToolResultClearingStrategy, SummarizationStrategy, CompositeStrategy, TokenCounter, SystemInjector
- [neuron-loop](https://docs.rs/neuron-loop): Agentic while loop — AgentLoop, AgentLoopBuilder, run/run_step/run_stream, cancellation support, parallel tool execution
- [neuron-provider-anthropic](https://docs.rs/neuron-provider-anthropic): Anthropic Messages API — Claude models, streaming, prompt caching, thinking
- [neuron-provider-openai](https://docs.rs/neuron-provider-openai): OpenAI Chat Completions API — GPT models, streaming, structured output, EmbeddingProvider implementation
- [neuron-provider-ollama](https://docs.rs/neuron-provider-ollama): Ollama local inference — any GGUF model, NDJSON streaming
- [neuron-mcp](https://docs.rs/neuron-mcp): MCP integration — McpClient, McpToolBridge, McpServer (wraps rmcp)
- [neuron-runtime](https://docs.rs/neuron-runtime): Production runtime — SessionStorage, InputGuardrail/OutputGuardrail, GuardrailHook, LocalDurableContext, TracingHook, Sandbox
- [neuron](https://docs.rs/neuron): Umbrella crate with feature flags (anthropic, openai, ollama, mcp, runtime, full)

## Features

- **LLM providers** — Anthropic, OpenAI, Ollama, each in its own crate with `from_env()` convenience constructors
- **Tool system** — `ToolRegistry`, `#[neuron_tool]` derive macro, composable middleware pipeline (axum's `from_fn` pattern)
- **Context management** — 4 compaction strategies, token counting, persistent context, system prompt injection
- **Agent loop** — configurable `AgentLoop` with streaming, max turns, tool dispatch, cancellation via `CancellationToken`, parallel tool execution
- **MCP** — full Model Context Protocol: client (stdio + Streamable HTTP), server, `McpToolBridge`
- **Embedding** — `EmbeddingProvider` trait for embedding models, separate from `Provider`; OpenAI implementation ships in `neuron-provider-openai`
- **Runtime** — sessions, input/output guardrails, `GuardrailHook` (wires guardrails into `ObservabilityHook`), `PermissionPolicy`, `Sandbox` trait, `DurableContext`
- **Observability** — `TracingHook` maps all hook events to structured `tracing` spans; use with `tracing-opentelemetry` for OTel export
- **Server-side compaction** — `ContextManagement` request field, loop continues automatically on `StopReason::Compaction`
- **Self-correction** — `ToolError::ModelRetry` converts tool errors to hints for the model to retry
- **Convenience** — `Message::user()`, `ToolContext::default()`, `from_env()` on all providers

## Landscape: how neuron compares

### vs Rig (leading Rust LLM library)

Monolithic `rig-core` with satellite vector stores. Many providers compiled into one crate. Well-designed traits, structured output, hook control flow, large example set — but no decomposition, no durability, no context management, no tool middleware. You can't use the types without pulling everything.

### vs ADK-Rust (community project by Zavora AI, not Google)

Most decomposed Rust agent framework (agent, model, tool, runner, graph, session, telemetry, server). But: all 14+ providers in one crate behind feature flags; core has 11 files that cascade on every change; partial independence (agent hard-depends on model implementation); no durability; context management is a stub.

### vs Python frameworks

| Framework | What neuron adopts | What neuron leaves to SDKs |
|-----------|-------------------|---------------------------|
| **Claude Code** | Loop pattern, context compaction, tool middleware, system reminder injection, server-side compaction | Monolith internals |
| **Pydantic AI** | `ModelRetry` self-correction, step-by-step iteration | `Agent[Deps, Output]` generics, graph FSM |
| **OpenAI Agents SDK** | Guardrails with tripwires, streaming events | Handoff protocol, single-package design |

### Feature matrix

| Capability | Rig | ADK-Rust | neuron |
|-----------|-----|---------|--------|
| True crate independence | No | Partial | **Yes** |
| Provider-per-crate | No | No | **Yes** |
| Tool middleware pipeline | No | No | **Yes** |
| Context compaction strategies | No | Stub | **Yes** |
| Durable execution | No | No | **Yes** |
| MCP full spec | Thin wrapper | Partial | **Yes** |
| Thinking/reasoning | Partial | Unclear | **Yes** |
| Structured output | Via schemars | Unclear | **Yes** |
| Prompt caching | No | No | **Yes** |
| Server-side compaction | No | No | **Yes** |
| Native async (Rust 2024) | Yes | Yes | **Yes** |
| WASM compatibility | Yes | No | **Yes** |
| Guardrails | No | Yes | **Yes** |
| Graph/DAG workflows | Op trait | Yes | No (not our concern) |

## Examples

- [Full agent with Anthropic](https://github.com/secbear/neuron/blob/main/neuron/examples/full_agent.rs): End-to-end agent loop with tools and context
- [Custom tool](https://github.com/secbear/neuron/blob/main/neuron-tool/examples/custom_tool.rs): Define, register, and execute tools with middleware
- [Tool middleware](https://github.com/secbear/neuron/blob/main/neuron-tool/examples/middleware.rs): Logging and auth middleware on tool calls
- [Model retry](https://github.com/secbear/neuron/blob/main/neuron-tool/examples/model_retry.rs): ToolError::ModelRetry for self-correction
- [Context compaction](https://github.com/secbear/neuron/blob/main/neuron-context/examples/compaction.rs): Sliding window strategy on a growing conversation
- [Multi-turn loop](https://github.com/secbear/neuron/blob/main/neuron-loop/examples/multi_turn.rs): Multi-turn conversation with mock provider
- [Agent loop](https://github.com/secbear/neuron/blob/main/neuron-loop/examples/agent_loop.rs): Step-by-step loop execution with mock provider
- [MCP client](https://github.com/secbear/neuron/blob/main/neuron-mcp/examples/mcp_client.rs): Connect to MCP server, discover and bridge tools
- [Session management](https://github.com/secbear/neuron/blob/main/neuron-runtime/examples/sessions.rs): Create, save, load sessions with FileSessionStorage
- [Guardrails](https://github.com/secbear/neuron/blob/main/neuron-runtime/examples/guardrails.rs): Input/output safety checks
- [Streaming](https://github.com/secbear/neuron/blob/main/neuron-provider-anthropic/examples/streaming.rs): Streaming token output
- [Context management](https://github.com/secbear/neuron/blob/main/neuron-provider-anthropic/examples/context_management.rs): Server-side compaction
- [Multi-provider](https://github.com/secbear/neuron/blob/main/neuron/examples/multi_provider.rs): Same request to Anthropic and OpenAI
- [Structured output](https://github.com/secbear/neuron/blob/main/neuron/examples/structured_output.rs): JSON Schema-constrained responses
- [TracingHook](https://github.com/secbear/neuron/blob/main/neuron-runtime/examples/tracing_hook.rs): Structured tracing output from hook events
- [LocalDurableContext](https://github.com/secbear/neuron/blob/main/neuron-runtime/examples/local_durable.rs): Passthrough durable context for local development
- [Anthropic provider](https://github.com/secbear/neuron/blob/main/neuron-provider-anthropic/examples/basic.rs): Direct provider usage
- [OpenAI provider](https://github.com/secbear/neuron/blob/main/neuron-provider-openai/examples/basic.rs): Direct provider usage
- [Ollama provider](https://github.com/secbear/neuron/blob/main/neuron-provider-ollama/examples/basic.rs): Direct provider usage
- [Derive tool macro](https://github.com/secbear/neuron/blob/main/neuron-tool/examples/derive_tool.rs): `#[neuron_tool]` proc-macro with custom types and registry
- [Embeddings](https://github.com/secbear/neuron/blob/main/neuron-provider-openai/examples/embeddings.rs): EmbeddingProvider with OpenAI, cosine similarity
- [Cancellation](https://github.com/secbear/neuron/blob/main/neuron-loop/examples/cancellation.rs): CancellationToken stops the agent loop cooperatively
- [Parallel tools](https://github.com/secbear/neuron/blob/main/neuron-loop/examples/parallel_tools.rs): Concurrent tool execution via join_all
- [Full production](https://github.com/secbear/neuron/blob/main/neuron-runtime/examples/full_production.rs): Sessions + guardrails + TracingHook composed
- [Testing agents](https://github.com/secbear/neuron/blob/main/neuron/examples/testing_agents.rs): Mock provider patterns for unit testing agents

## Requirements

Rust 1.90+ (edition 2024, native async traits). WASM-compatible via WasmCompatSend/Sync bounds. Licensed MIT OR Apache-2.0.

## Links

- [Documentation](https://secbear.github.io/neuron/): Guides, architecture, and reference (mdBook)
- [Source code](https://github.com/secbear/neuron)
- [API reference](https://docs.rs/neuron): docs.rs auto-generated API docs
- [Roadmap](https://github.com/secbear/neuron/blob/main/ROADMAP.md): current work, planned features, and explicit non-goals
- [Architecture & design decisions](https://github.com/secbear/neuron/blob/main/CLAUDE.md): Internal design guide for contributors
